<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AI Learning Lab</title>
  <style>
    body { margin: 0; font-family: Arial, sans-serif; }
    #landing, #chat-interface { padding: 1rem; }
    #profiles button { display: block; margin: 0.5rem 0; }
    #topbar { display: flex; align-items: center; background: #f5f5f5; padding: 0.5rem 1rem; border-bottom: 1px solid #ccc; }
    #topbar img { width: 40px; height: 40px; border-radius: 50%; margin-right: 1rem; }
    #container { display: flex; height: calc(100vh - 70px); }
    #sidebar { width: 200px; border-right: 1px solid #ccc; padding: 1rem; }
    #chat-area { flex: 1; display: flex; flex-direction: column; }
    #chat { flex: 1; padding: 1rem; overflow-y: auto; }
    #input-area { border-top: 1px solid #ccc; padding: 0.5rem; }
    .user { color: blue; }
    .bot { color: green; }
  </style>
</head>
<body>

  <div id="landing">
    <h1>Select Your Profile</h1>
    <div id="profiles"></div>
  </div>

  <div id="chat-interface" style="display:none;">
    <input type="hidden" id="user-id" />
    <div id="topbar">
      <img id="profile-avatar" src="" alt="avatar" />
      <span id="profile-name"></span>
      <span style="margin-left:auto;">AI Learning Lab</span>
    </div>
    <div id="container">
      <div id="sidebar">
        <h3>Configuration</h3>
        <label for="persona-select">Persona:</label>
        <select id="persona-select">
          <option value="">Default</option>
          <option value="robot">Robot Gremlin</option>
          <option value="wizard">Wizard</option>
          <option value="fairy">Fairy</option>
          <option value="pirate">Pirate</option>
        </select>
      </div>
      <div id="chat-area">
        <div id="chat"></div>
        <div id="input-area">
          <input id="prompt" type="text" placeholder="Say something..." size="40" />
          <button id="send-btn">Send</button>
          <button id="listen-btn">ðŸŽ¤</button>
        </div>
      </div>
    </div>
  </div>


  <script src="config.js"></script>
  <script>
    const landing = document.getElementById('landing');
    const chatInterface = document.getElementById('chat-interface');
    const profilesDiv = document.getElementById('profiles');
    const chatDiv = document.getElementById('chat');
    const promptInput = document.getElementById('prompt');
    const personaSelect = document.getElementById('persona-select');
    const profileName = document.getElementById('profile-name');
    const profileAvatar = document.getElementById('profile-avatar');
    const userIdField = document.getElementById('user-id');

    const synth = window.speechSynthesis;

    const personas = {
      robot: 'You are a mischievous robot gremlin. Respond with playful mechanical mischief.',
      wizard: 'You are a wise old wizard. Respond with arcane wisdom and spells.',
      fairy: 'You are a whimsical fairy. Respond with a light-hearted and magical tone.',
      pirate: 'You are a swashbuckling pirate. Speak with pirate lingo.'
    };

    let systemPrompt = '';
    let userId = null;
    const API_BASE = '';

    async function loadProfiles() {
      const res = await fetch(`${API_BASE}/profiles`);
      const profiles = await res.json();
      profiles.forEach((p) => {
        const btn = document.createElement('button');
        btn.textContent = p.name;
        btn.onclick = () => selectProfile(p);
        profilesDiv.appendChild(btn);
      });
    }

    async function selectProfile(profile) {
      try {
        const res = await fetch('/users', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name: profile.name })
        });
        if (!res.ok) throw new Error('User creation failed');
        const data = await res.json();
        userIdField.value = data.id;
        landing.style.display = 'none';
        chatInterface.style.display = 'block';
        profileName.textContent = profile.name;
        if (profile.avatar) profileAvatar.src = profile.avatar;
        loadHistory();
      } catch (err) {
        console.error('Failed to create user', err);
        alert('Could not create user profile. Please try again.');
      }

    }

    personaSelect.addEventListener('change', () => {
      systemPrompt = personas[personaSelect.value] || '';
    });

    async function sendMessage(text) {
      const message = text || promptInput.value;
      if (!message) return;
      appendMessage('user', message);
      promptInput.value = '';

      const response = await fetch(`${API_BASE}/chat/stream`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          user_id: userIdField.value,
          message,
          system_prompt: systemPrompt
        })
      });

      const reader = response.body.getReader();
      const decoder = new TextDecoder();
      const botP = appendMessage('bot', '');
      let botText = '';
      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        const chunk = decoder.decode(value, { stream: true });
        botText += chunk;
        botP.textContent += chunk;
        chatDiv.scrollTop = chatDiv.scrollHeight;
      }
      speak(botText);
    }

    async function loadHistory() {
      chatDiv.innerHTML = '';
      const userId = userIdField.value;
      if (!userId) return;
      const res = await fetch(`${API_BASE}/users/${userId}/history`);
      const data = await res.json();
      data.history.forEach(msg => appendMessage(msg.role, msg.content));
    }

    function appendMessage(sender, text) {
      const p = document.createElement('p');
      p.className = sender;
      p.textContent = text;
      chatDiv.appendChild(p);
      chatDiv.scrollTop = chatDiv.scrollHeight;
      return p;
    }

    function speak(text) {
      const utterance = new SpeechSynthesisUtterance(text);
      synth.speak(utterance);
    }

    async function startListening() {
      if (!window.OPENAI_API_KEY) {
        alert('OpenAI API key not configured');
        return;
      }
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const recorder = new MediaRecorder(stream);
        const chunks = [];
        recorder.ondataavailable = e => chunks.push(e.data);
        recorder.onstop = async () => {
          const blob = new Blob(chunks, { type: 'audio/webm' });
          const formData = new FormData();
          formData.append('file', blob, 'speech.webm');
          formData.append('model', 'whisper-1');
          try {
            const res = await fetch('https://api.openai.com/v1/audio/transcriptions', {
              method: 'POST',
              headers: { Authorization: `Bearer ${window.OPENAI_API_KEY}` },
              body: formData
            });
            const data = await res.json();
            if (data.text) {
              sendMessage(data.text);
            } else {
              console.error('Transcription error', data);
              alert('Transcription failed');
            }
          } catch (err) {
            console.error('Transcription request failed', err);
            alert('Transcription request failed');
          }
        };
        recorder.start();
        setTimeout(() => recorder.stop(), 5000);
      } catch (err) {
        console.error('Could not access microphone', err);
        alert('Could not access microphone');
      }
    }

    document.getElementById('send-btn').onclick = () => sendMessage();
    document.getElementById('listen-btn').onclick = () => startListening();

    loadProfiles();
  </script>
</body>
</html>

