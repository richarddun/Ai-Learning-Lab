<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AI Learning Lab</title>
  <style>
    body { margin: 0; font-family: Arial, sans-serif; }
    #landing, #chat-interface { padding: 1rem; }
    #profiles button { display: block; margin: 0.5rem 0; }
    #topbar { display: flex; align-items: center; background: #f5f5f5; padding: 0.5rem 1rem; border-bottom: 1px solid #ccc; }
    #topbar img { width: 40px; height: 40px; border-radius: 50%; margin-right: 1rem; }
    #container { display: flex; height: calc(100vh - 70px); }
    #sidebar { width: 200px; border-right: 1px solid #ccc; padding: 1rem; }
    #chat-area { flex: 1; display: flex; flex-direction: column; }
    #chat { flex: 1; padding: 1rem; overflow-y: auto; }
    #input-area { border-top: 1px solid #ccc; padding: 0.5rem; }
    .user { color: blue; }
    .bot { color: green; }
  </style>
</head>
<body>

  <div id="landing">
    <h1>Select Your Profile</h1>
    <div id="profiles"></div>
  </div>

  <div id="chat-interface" style="display:none;">
    <div id="topbar">
      <img id="profile-avatar" src="" alt="avatar" />
      <span id="profile-name"></span>
      <span style="margin-left:auto;">AI Learning Lab</span>
    </div>
    <div id="container">
      <div id="sidebar">
        <h3>Configuration</h3>
        <label for="persona-select">Persona:</label>
        <select id="persona-select">
          <option value="">Default</option>
          <option value="robot">Robot Gremlin</option>
          <option value="wizard">Wizard</option>
          <option value="fairy">Fairy</option>
          <option value="pirate">Pirate</option>
        </select>
      </div>
      <div id="chat-area">
        <div id="chat"></div>
        <div id="input-area">
          <input id="prompt" type="text" placeholder="Say something..." size="40" />
          <button id="send-btn">Send</button>
          <button id="listen-btn">ðŸŽ¤</button>
        </div>
      </div>
    </div>
  </div>


  <script>
    const landing = document.getElementById('landing');
    const chatInterface = document.getElementById('chat-interface');
    const profilesDiv = document.getElementById('profiles');
    const chatDiv = document.getElementById('chat');
    const promptInput = document.getElementById('prompt');
    const personaSelect = document.getElementById('persona-select');
    const profileName = document.getElementById('profile-name');
    const profileAvatar = document.getElementById('profile-avatar');

    const synth = window.speechSynthesis;

    const personas = {
      robot: 'You are a mischievous robot gremlin. Respond with playful mechanical mischief.',
      wizard: 'You are a wise old wizard. Respond with arcane wisdom and spells.',
      fairy: 'You are a whimsical fairy. Respond with a light-hearted and magical tone.',
      pirate: 'You are a swashbuckling pirate. Speak with pirate lingo.'
    };

    let systemPrompt = '';
    let userId = null;

    async function loadProfiles() {
      const res = await fetch('/profiles');
      const profiles = await res.json();
      profiles.forEach((p) => {
        const btn = document.createElement('button');
        btn.textContent = p.name;
        btn.onclick = () => selectProfile(p);
        profilesDiv.appendChild(btn);
      });
    }

    function selectProfile(profile) {
      landing.style.display = 'none';
      chatInterface.style.display = 'block';
      profileName.textContent = profile.name;
      if (profile.avatar) profileAvatar.src = profile.avatar;
      userId = profile.id;
    }

    personaSelect.addEventListener('change', () => {
      systemPrompt = personas[personaSelect.value] || '';
    });

    async function sendMessage(text) {
      const message = text || promptInput.value;
      if (!message) return;
      appendMessage('user', message);
      promptInput.value = '';

      const response = await fetch('/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },

        body: JSON.stringify({ user_id: userId, message, system_prompt: systemPrompt })

      });
      const data = await response.json();
      appendMessage('bot', data.response);
      speak(data.response);
    }

    async function loadHistory() {
      chatDiv.innerHTML = '';
      const userId = userIdInput.value;
      if (!userId) return;
      const res = await fetch(`/users/${userId}/history`);
      const data = await res.json();
      data.history.forEach(msg => appendMessage(msg.role, msg.content));
    }

    function appendMessage(sender, text) {
      const p = document.createElement('p');
      p.className = sender;
      p.textContent = text;
      chatDiv.appendChild(p);
      chatDiv.scrollTop = chatDiv.scrollHeight;
    }

    function speak(text) {
      const utterance = new SpeechSynthesisUtterance(text);
      synth.speak(utterance);
    }

    function startListening() {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        alert('Speech recognition not supported');
        return;
      }
      const recognition = new SpeechRecognition();
      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        sendMessage(transcript);
      };
      recognition.start();
    }

    document.getElementById('send-btn').onclick = () => sendMessage();
    document.getElementById('listen-btn').onclick = () => startListening();

    loadProfiles();
  </script>
</body>
</html>

